# 修改员工信息
- 步骤：
  1. 查询回显（员工基本信息、员工工作经历信息）
  2. 修改信息

# 一、根据 ID 查询员工信息
1、请求方式：URL路径查询，`GET /emps/${id}`
2、查询操作：需要查询 `emp、emp_expr` 两张表，并封装数据。
3、三层架构实现：
  Controller 层：
    1、接收请求参数( ID值)；
    2、调用Service方法；
    3、响应结果；
  Service 层：
    1、调用mapper查询员工详细信息(基本信息 + 工作经历信息)；
  Mapper 层：
    1、需实现连接查询sql语句：


Mapper 层查询时有2种方式：

* 方式一：连接查询，同时查询2张表
如下 sql 所示，由于2张表中有重命名的字段，所以sql查询时需要取别名，如下所示：
```sql
select e.*,
    ex.id  ee_id,
    ex.emp_id ee_empId,
    ex.begin ee_begin,
    ex.end ee_end,
    ex.company ee_company,
    ex.job ee_job
from emp e left join emp_expr ex on e.id = ex.emp_id 
where e.id = 15;
```

* 方式二：单表查询，查2次表，然后对数据进行封装。
代码实现：`EmpServiceImpl.java > getById2`


# 二、Mybatis 结果封装 ⚠️⚠️⚠️
- 案例结果：如上代码所示，采用方式一外连接查询时，同时查询2张表，查询结果为：一个员工的基本信息为多条记录。
- 原因：因为，一个员工多段工作经历，sql语句外连接查询时以多条数据展示。
- 实现：Mybatis 基于XML实现 动态sql 查询。

> 此sql查询结果为多条记录，那么如何使用 Mybatis 将这多条记录封装到一个实体类中？

## 2.1、resultType 自动结果封装
如果查询返回的字段名与实体的属性名可以直接对应上，用 `resultType`；

```xml
<!--
    resultType="com.czm.entity.Emp"， resultType 自动结果封装，表示 SQL 语句查询到一条数据后封装到 Emp 对象中；
-->
<select id="getById" resultType="com.czm.entity.Emp">
</select>
```

## 2.2、resultMap 手动结果封装
如果查询返回的字段名与实体的属性名对应不上，或实体属性比较复杂，可以通过 `resultMap` 手动封装。
具体代码实现：`src/main/resources/.../EmpMapper.xml`

* 步骤1，使用 `<resultMap />` 标签用于自定义结果封装，将数据库表的列（column）精确地映射到 Java 实体类的属性（property）上

```xml
<!--
    <resultMap /> 标签自定义结果封装，定义sql查询结果集与java对象属性之间的映射关系。
        type：映射的Java 实体类；
        autoMapping：开启自动映射，所以映射属性不必全部写；
-->
<resultMap id="empResultMap" type="com.czm.entity.Emp" autoMapping="true">
    <!-- 1、主键映射 -->
    <id property="id" column="user_id"/>          
    <!-- 2、普通字段映射 -->
    <result column="username" property="username" />  

    <!-- 3、<collection /> 标签用于封装集合数据，适用于一对多关系 -->
    <collection property="exprList" ofType="com.czm.entity.EmpExpr">
        <result column="ee_id" property="id" />
    </collection>
</resultMap>
```

* 步骤2，使用 自定义结果封装
```xml
<!--
    resultMap 的值为自定义 <resultMap /> 标签的 id 属性值，表示把查询出来的结果封装到 empResultMap 中。
-->
<select id="getById" resultMap="empResultMap">
    <!-- sql 语句-->
</select>
```



# 三、修改员工信息
1、实现要求：修改员工基本信息 + 员工工作经历信息（增、删、改）
2、请求接口：`PUT /emps application/json`
3、三层架构实现：
  - Controller 层：
    1、接收json格式请求参数；
    2、调用 Service 方法；
    3、响应请求结果；
  
  - Service 层：
   1、根据ID修改员工基本信息。
   2、根据ID修改员工工作经历信息。由于这个操作有3种（增、删、改），实现方式为：先删除再全部添加。
   3、由于操作2张表，所以要开启事务： `@Transactional(rollbackFor = {Exception.class})`

  - Mapper 层：
   1、更新员工基本信息操作 emp 表，由于可能出现有些员工信息不传，所以需要使用动态 sql;
   2、更新工作经历信息时可能有3种操作（删、增、改），简化逻辑后采用 先全删后批量插入，也需要动态 sql；

代码实现：`EmpServiceImpl.java  > update`

