# 一、案例-新增员工信息
1、新增员工信息：员工基本信息+工作经历，对应操作2张表（emp、emp_expr）。
2、前端发送 Post 请求，请求参数为 JSON 格式，如下所示：
```json
{
    "username": "lvbu",
    "name": "吕布",
    "gender": 1,
    "phone": "13424858432",
    "job": 1,
    "salary": 18000,
    "image": "https://loremflickr.com/400/400?lock=8425362492636357",
    "entryDate": "1020-09-28",
    "deptId": 2,
    "exprList": [
        {
            "job": "一把手",
            "company": "董卓集团",
            "end": "1009-02-01",
            "begin": "1890-02-01"
        },
        {
            "job": "一把手",
            "company": "丁原集团",
            "end": "1800-02-01",
            "begin": "1820-02-01"
        }
    ]
}
```
3、sql语句的实现：

```sql
-- 新增员工
insert into emp(username, name,gender, phone, job, salary, image, entry_date, dept_id, create_time, update_time)
    values ('lvbu', '吕布', 1, 13424858432, 1, 18000, '1.jpg', '2020-01-01', 1, '2024-10-01 00:00:00', '2024-10-01 00:00:00');
-- 新增员工工作经历
insert into emp_expr(emp_id, begin, end, company, job) 
    values (35, '2020-01-01', '2021-01-01', '百度', 'java开发'),
           (35, '2022-01-01', '2023-01-01', '阿里', 'java开发');
```
- `emp`员工基本信息表插入时：
  主键 `id`，传递 null 让数据库会自动生成即可；
  Service 层手动补充基础属性：`password、create_time、update_time`；
- 向 `emp_expr` 工作经历表批量插入时：
  需要用到 emp 的主键 id 赋值给 `emp_id` ，让 emp 和 emp_expr 表建立关系；
  工作经历是个动态的，可能有多个对象，需要 动态SQL 的方式执行；

## 三层架构实现步骤
- Controller 层
1、接收请求参数（员工信息 json格式）
2、调用 Service 方法
3、响应结果

- Service 层
调用 Mapper 执行如下操作：
1、保存员工基本信息，另外需手动补充基础属性：updateTime 等；
2、批量保存员工工作经历信息

- Mapper 层
1、insert 方式操作2张表：emp、emp_expr。




# 二、项目实现注意点

## 2.1、Mybatis 主键返回 ⚠️⚠️⚠️
emp_expr表 插入时如何获取 emp表 执行的结果？
向 emp_expr表 插入数据时需要当前员工ID，而当前员工信息是新增的，其主键ID是数据库表自动生成的，那么如何获取 emp表 的主键ID？

- 方式1，Mybatis 基于注解开发时，`@Options` 注解
```java
/**
 * Mybatis 的 @Options 注解，用于返回自动生成的主键，其属性含义如下：
 *      useGeneratedKeys，表示要使用数据库表自动生成主键；
 *      keyProperty，表示获取到的主键要封装到实体类中的那个属性；
 */
@Options(useGeneratedKeys = true, keyProperty = "id")   // @Options 注解，表示执行 sql 完毕后，把主键 id 取出来赋值给 emp 对象的 id 属性
@Insert("insert into emp values (null,#{username},#{password},#{name},#{gender},#{phone},#{job},#{salary},#{image},#{entryDate},#{deptId}," +
        "#{createTime},#{updateTime})")
void insert(Emp emp);
```

- 方式2，Mybatis 基于XML开发，返回新增记录的主键ID
```xml
<insert id="insertXml" useGeneratedKeys="true" keyProperty="id">
```

## 2.2、动态 SQL - <foreach> 批量插入数据
工作经历插入时，是多条数据，即动态的，需要通过 XML 方式实现。
```xml
<!-- 批量插入数据
  <foreach> 标签：用于循环遍历生成sql语句，其属性含义如下：
    1. collection：被遍历集合名称；
    2. item：集合遍历出来的元素/项；
    3. separator：每一次遍历使用的分隔符；
    4. open：遍历开始前拼接的片段；
    5. close：遍历结束后拼接的片段；
-->
<insert id="insertBatch">
    insert into emp_expr values
    <foreach collection="exprList" item="expr" separator=",">
        (null,#{expr.empId},#{expr.begin},#{expr.end},#{expr.company},#{expr.job})
    </foreach>
</insert>
```
