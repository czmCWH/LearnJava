# 一、Spring AOP 案例 - 记录登录用户的操作日志
1、需求
将案例中增、删、改相关接口的操作日志记录到数据库表中。
日志信息包含：操作人、操作时间、执行方法的全类名、执行方法名、方法运行时参数、返回值、方法执行时长

2、实现分析
- 使用 `Spring AOP` 那种通知类型？
    `@Around` 环绕通知

- 切入点表达式该怎么写?
     由于增、删、改 方法名我们定义的比较规范，分别为save、delete、update。
     方式1，声明 execution 切入点表达式如下：
     ```java
     @Around("execution(* com.czm.controller.*.save(..)) ||" 
             + "execution(* com.czm.controller.*.delete(..)) ||" 
             + "execution(* com.czm.controller.*.update(..)) ||")
     ```
     方式2，什么 @annotation 切入点表达式：
     
     ```java
     @Around("@annotation(com.czm.anno.Log)")
     ```
     推荐使用方法2，因为方式1比较繁琐，限制较多。

- 日志表建表sql
```sql
-- 创建操作日志表
create table operate_log(
    id int unsigned primary key auto_increment comment '主键ID',
    operate_emp_id int unsigned comment '操作人ID',
    operate_time datetime comment '操作时间',
    class_name varchar(100) comment '操作的类名',
    method_name varchar(100) comment '操作的方法名',
    method_params varchar(2000) comment '方法参数',
    return_value varchar(2000) comment '返回值',
    cost_time bigint unsigned comment '方法执行耗时，单位:ms'
) comment '操作日志表';
```

> 代码实现：`OperationLogAspect.java`
> 案例流程分析：`img/05-记录登录用户操作日志的完整流程.jpg`


# 二、ThreadLocal
- 问题：
  如上记录用户的操作日志，如何获取用户上下文信息？

- 问题分析：
  如上需求实现中，在 Spring AOP 的切面类`OperationLogAspect.java`中记录日志信息时，需要保存用户ID。
    但是用户ID是通过 过滤器(Filter)、拦截器(interceptor) 中 Token 解析出来，那么如何将其传递给 Controller、Service 层，以及Spring AOP 程序？

- 解决方案：JavaWeb 程序中管理用户上下文信息的方案：`ThreadLocal` 或 `Spring Security`。
- 代码实现：`/project14-springboot-login/.../LoginCheckFilter.java`

## ThreadLocal
ThreadLocal 并不是一个 Thread，而是 Thread 的局部变量。
ThreadLocal 其实是线程的局部变量，为每个线程提供一份单独的存储空间，具有线程隔离的效果，不同的线程之间不会相互干扰。

ThreadLocal 常用方法：
    - `public void set(T value)`，设置当前线程的线程局部变量的值。
    - `public T get()`，返回当前线程所对应的线程局部变量的值。
    - `public void remove()`，移除当前线程的线程局部变量。

> ThreadLocal 基本使用，见代码：`/test/.../ThreadLocalTest.java`。

ThreadLocal 应用场景：
在同一个线程/同一个请求中，进行数据共享。

## 为什么请求执行过程中，各层的 ThreadLocal 存储相同？
当前端请求到达 Tomcat 服务器时，Tomcat 服务器接收到请求时，会从线程池中获取一个线程来处理该请求，直到该请求执行完毕。
这就意味着，一次请求对应一个线程，每一次请求都会有一个独立线程来处理。
