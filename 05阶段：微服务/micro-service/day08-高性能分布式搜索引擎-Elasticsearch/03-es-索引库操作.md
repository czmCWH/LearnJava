# 一、索引库操作
- es索引库操作 相当于关系型数据库中表操作。
- ⚠️ 如下操作我们借助 `kibana` 的 `Dev Tools` 工具测试，因为 kibana 中有命令自动补全功能。

## 1、Mapping 映射常用属性 
mapping 是对索引库中文档的约束，类似数据库表结构约束，常见的 mapping 属性包括：

### 1.1、type：字段数据类型，常见的简单类型有:

    1、字符串：`text`(可分词的文本)、`keyword`(精确值，即文本分词后就失去意义，例如：品牌、国家、ip地址)
    2、数值：`long、integer、short、byte、double、float`，与 java 中完全一致。
    3、布尔：`boolean`
    4、日期：`date`
    5、对象：`object`

### 1.2、index：是否创建索引，默认为true
如果 `index` 值为 `true`，表示 `es` 可以根据此 `field`(字段) 创建倒排索引进行搜索；
如果 `index` 值为 `false`，那么将无法根据此字段进行搜索、排序；

### 1.3、analyzer：使用那种分词器
只有字段类型为 `type: text` 时，才需要 analyzer；
默认值为 `standard`，如果安装了 ik 分词器插件，则可以使用 `ik_smart`、`ik_max_word`。

### 1.4、properties：该字段的子字段
`properties` 针对于 `type: object` 类型的字段。


## 2、索引库 常见操作
`Elasticsearch` 提供的所有 `API` 都是 `Restful` 的接口，遵循 `Restful` 的基本规范：

    接口类型        请求方式        请求路径                请求参数
    查询用户          GET         /users/{id}            路径中的id
    新增用户          POST         /users                json格式user对象
    修改用户          PUT          /users/{id}           路径中的id & json格式对象
    删除用户         DELETE        /users/{id}           路径中的id

索引库的基本操作有如下几种：
1. 创建索引库：PUT /索引库名 
2. 查询索引库：GET/索引库名 
3. 删除索引库：DELETE/索引库名 
4. 添加字段：PUT/索引库名/mapping

> ⚠️：Elasticsearch 的 索引库 和 `mapping` 一旦创建无法修改，但是可以添加新的字段。

### 2.1、索引库操作语法

```
# 1、创建索引库和 mapping 的请求语法如下：
put /索引库名称
{
    "mappings": {
        "properties": {
            "字段名": {
                "type": "text",
                "analyzer": "ik_smart"
            },
             "字段名2": {
                "type": "keyword",
                "index": "false"
            },
             "字段名3": {
                "properties": {
                    "子字段": {
                        "type": "keyword"
                    }
                }
            },
        }
    }
}

# 2、新增索引库字段
# 索引库 和 `mapping` 一旦创建无法修改，但是可以添加新的字段，语法如下:
PUT /索引库名/_mapping
{
  "properties": {
    "新字段名": {
      "type": "integer"
    }
  }
}
```

### 2.2、索引库操作示例
复制如下命令在 `kibana` -> `Dev Tools` 中执行： 
```
# 创建索引库 heima 并设置 mapping 映射
PUT /heima
{
  "mappings": {
    "properties": {
      "info": {
        "type": "text",
        "analyzer": "ik_smart"
      },
      "email": {
        "type": "keyword",
        "index": false
      },
      "name": {
        "type": "object",
        "properties": {
          "firstName": {
            "type": "keyword"
          },
          "lastName": {
            "type": "keyword"
          }
        }
      }
    }
  }
}

# 查询索引库
GET /heima

# 查询索引库 mapping 映射
GET /items/_mapping

# 删除索引库
DELETE /heima

# 修改索引库 - 新增 Mapping
PUT /heima/_mapping
{
  "properties": {
    "age": {
      "type": "byte"
    }
  }
}
```


## 3、文档操作 - 文档CRUD

### 3.1、基本语法

```
# 新增文档的请求格式如下，返回201，表示新增成功:
# 新增文档时如果不指定文档id，会随机生成，不方便后续操作
POST /索引库名/_doc/文档id
{
  "字段1": "值1",
  "字段2": "值2",
  "字段3": {
    "子属性1": "值3",
    "子属性2": "值4"
  }
  //...
}


# 查询文档请求格式：
GET /索引库名/_doc/文档id

# 删除文档请求格式：
DELETE /索引库名/_doc/文档id

# 修改文档：
# 方式1：全量修改，如果文档id存在，则先删除后新增；如果文档id不存在，则新增；
PUT /索引库名/_doc/文档id
{
  "字段1": "值1",
  "字段2": "值2",
  //...
}

# 方式2：增量修改，修改指定字段值，局部修改
POST /索引库名/_update/文档id
{
  "doc": {
    "字段名": "新的值"
  }
}
```

### 3.2、代码实现
```
# 新增文档
POST /heima/_doc/1
{
  "info": "黑马程序员Java讲师",
  "email": "zy@itcast.cn",
  "name": {
    "firstName": "云",
    "lastName": "赵"
  }
}

# 查询文档
GET /heima/_doc/1
# 查询文档结果，_source：表示原始数据，即新增提交的json数据。
{
  "_index" : "heima",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 2,
  "_seq_no" : 5,
  "_primary_term" : 1,
  "found" : true,
  "_source" : {
    "info" : "黑马程序员Java讲师",
    "email" : "ZhaoYun@itcast.cn",
    "name" : {
      "firstName" : "云",
      "lastName" : "赵"
    }
  }
}


# 删除文档
DELETE /heima/_doc/1

# 修改文档 - 全量修改
PUT /heima/_doc/1
{
  "info": "黑马程序员Java讲师",
  "email": "ZY@itcast.cn",
  "name": {
    "firstName": "云",
    "lastName": "赵"
  }
}

# 修改文档 - 增量修改
POST /heima/_update/1
{
  "doc": {
    "email": "ZhaoYun@itcast.cn"
  }
}
```


## 4、文档操作 - 批量处理
`Elasticsearch` 中允许通过一次请求中携带多次文档操作，也就是批量处理，语法格式如下：
```shell
POST /_bulk
{ "index": { "_index": "索引库名", "_id": "1" } }
{ "字段1": "值1", "字段2": "值2" }
{ "index": { "_index": "索引库名", "_id": "2" } }
{ "字段1": "值1", "字段2": "值2" }
{ "index": { "_index": "索引库名", "_id": "3" } }
{ "字段1": "值1", "字段3": "值3" }
{ "delete": { "_index": "test", "_id": "2" } }
{ "update": { "_index": "test", "_id": "1" } }
{ "doc": { "字段1": "值1" } }
```

代码实现如下：
```
# 批量处理
# 批量新增
POST /_bulk
{ "index": { "_index": "heima", "_id": "3" } }
{"info":"黑马程序员C++讲师", "email":"ww@itcast.cn","name":{"firstName":"王", "lastName":"五"}}
{ "index": { "_index": "heima", "_id": "4" } }
{"info":"黑马程序员鸿蒙讲师", "email":"zs@itcast.cn","name":{"firstName":"张", "lastName":"三"}}

# 批量删除
POST /_bulk
{ "delete": { "_index": "heima", "_id": "3" } }
{ "delete": { "_index": "heima", "_id": "4" } }
```